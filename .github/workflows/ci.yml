name: BloodMoney CI
on:
  push:
    paths:
      - '**ci.yml'
      - '**/Config/**'
      - '**/Content/**'
      - '**/Source/**'
  pull_request:
    paths:
      - '**ci.yml'
      - '**/Config/**'
      - '**/Content/**'
      - '**/Source/**'

permissions:
  contents: read

jobs:
  windows: # Windows x64 and x86 build matrix
    permissions:
      contents: write
    strategy:
      fail-fast: false # Don't cancel other matrix jobs if one fails
      matrix:
        cfg:
        - { name: 'x64', config: Development, os: [self-hosted, Windows, X64], options: '' }
    name: "Windows ${{matrix.cfg.config}}"
    runs-on: ${{matrix.cfg.os}}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
        with:
          egress-policy: audit

      - name: Checkout Game
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          path: main

      - name: Build Project
        run: ""C:\Program Files\Epic Games\UE_5.5\Engine\Build\BatchFiles\RunUAT.bat"" -ScriptsForProject="${{github.workspace}}/main/untitledfightgame.uproject" -platform=Win64 -project="${{github.workspace}}/main/untitledfightgame.uproject" BuildCookRun -nop4 -utf8output -cook -target=untitledfightgame -unrealexe="C:\Program Files\Epic Games\UE_5.5\Engine\Binaries\Win64\UnrealEditor-Cmd.exe" -platform=Win64 -SkipCookingEditorContent -installed -stage -archive -package -build -pak -iostore -compressed -prereqs -archivedirectory="${{github.workspace}}/exports" -distribution -clientconfig=Shipping -nodebuginfo" -nocompile -nocompileuat

      - name: Package distributable
        run: cd export && Compress-Archive . winexport.zip

      - name: Upload Binary
        if: ${{ matrix.cfg.upload }}
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: "BloodMoney - Windows ${{matrix.cfg.config}}"
          path: '${{github.workspace}}/export/winexport.zip'
